@page "/"
@using Google.Protobuf
@using ProtoBuf.Logic
@using static ProtoBuf.Antlr.Protobuf3Parser


<MudGrid>
    <MudItem xs="12">
        <PageTitle>Protobuf Viewer</PageTitle>
    </MudItem>
    <MudItem xs="12" sm="4">
        <MudFileUpload T="IBrowserFile" Accept="*.proto" FilesChanged="MessageFileChanged" Hidden="@false" InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20" InputStyle="opacity:0">
            <ButtonTemplate>
                @if (ProtoFile == null)
                {
                    <MudPaper Height="300px" Outlined="true" Class="@DefaultDragClass">
                        <MudText Typo="Typo.h6">
                            Drag and drop the proto definition file here or click
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               for="@context.Id">
                        Change '@ProtoFile.Name' definition file
                    </MudButton>
                }
            </ButtonTemplate>
        </MudFileUpload>
        <MudTreeView T="MessageViewModel" Items="Messages" Context="message" @bind-SelectedValue="SelectedMessage">
            <ItemTemplate>
                <MudTreeViewItem Items="@message.Nested" Value="@message">
                    <BodyContent>
                        <MudTooltip ShowOnHover="@true" Delay="1000" Placement="Placement.End">
                            <ChildContent>
                                <MudText>@message.Name</MudText>
                                </ChildContent>
                                <TooltipContent>
                                    <MudText><pre style="text-align:left">@message.Definition</pre></MudText>
                            </TooltipContent>
                        </MudTooltip>
                    </BodyContent>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>
    </MudItem>
    <MudItem xs="12" sm="8">
        @if (SelectedMessage == null)
        {
            @if (ProtoFile != null)
            {
                <MudAlert Severity="Severity.Info" Style="margin-top: 10pt;">Select the root message type of the binary proto file</MudAlert>
            }
        }
        else
        {
            <MudFileUpload T="IBrowserFile" FilesChanged="BinFilesChanged" Hidden="@false" InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20" InputStyle="opacity:0">
                <ButtonTemplate>
                    @if (ProtoBinFile == null)
                    {
                        <MudPaper Height="300px" Outlined="true" Class="@DefaultDragClass">
                            <MudText Typo="Typo.h6">
                                Drag and drop the binary proto file with root message <code>@SelectedMessage.Name</code> here or click
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   for="@context.Id">
                            Change '@ProtoBinFile.Name' binary proto file
                        </MudButton>
                    }
                </ButtonTemplate>
            </MudFileUpload>
        }
        <VirtualTreeView T="ProtoType" Items="TypedMessages" ChildrenSelector="x => x switch {
            TypedMessage message => message.Fields,
            TypedField { Value: TypedMessage message } => message.Fields,
            _ => []
            }">
            <ItemTemplate>
                @switch (context)
                {
                    case TypedMessage message:
                        @message.MessageType
                        break;
                    case TypedField field:
                        <b>@field.Name:&nbsp;</b>
                        @switch (field.Value)
                        {
                            case TypedFloat x:
                                @x.Value
                                break;
                            case TypedInt32 x:
                                @x.Value
                                break;
                            case TypedInt64 x:
                                @x.Value
                                break;
                            case TypedUint32 x:
                                @x.Value
                                break;
                            case TypedUint64 x:
                                @x.Value
                                break;
                            case TypedSint32 x:
                                @x.Value
                                break;
                            case TypedSint64 x:
                                @x.Value
                                break;
                            case TypedFixed32 x:
                                @x.Value
                                break;
                            case TypedFixed64 x:
                                @x.Value
                                break;
                            case TypedSfixed32 x:
                                @x.Value
                                break;
                            case TypedSfixed64 x:
                                @x.Value
                                break;
                            case TypedBool x:
                                @x.Value
                                break;
                            case TypedString x:
                                @x.Value
                                break;
                            case TypedBytes x:
                                @x.Value
                                break;
                            case TypedUnknown x:
                                @x.Value
                                break;
                            case TypedEnum x:
                                @x.EnumValue
                                break;
                        }
                        break;
                }
            </ItemTemplate>
        </VirtualTreeView>
        <MudTreeView T="ProtoType" Context="typedValue">
            <ItemTemplate>
                @switch (typedValue)
                {
                    case TypedMessage message:
                        <MudTreeViewItem T="ProtoType" Items="@message.Fields.Select(x => (ProtoType)x).ToHashSet()" Text="@message.MessageType" />
                        break;
                    case TypedField field:
                        @if (field.Value is TypedMessage fieldMessage)
                        {
                            <MudTreeViewItem T="ProtoType" Items="@fieldMessage.Fields.Select(x => (ProtoType)x).ToHashSet()" Context="messageField">
                                <BodyContent>
                                    <MudTooltip ShowOnHover="@true" Delay="1000" Placement="Placement.Top">
                                        <ChildContent>
                                            <MudText><b>@field.Name:&nbsp;</b>@fieldMessage.MessageType</MudText>
                                            </ChildContent>
                                            <TooltipContent>
                                                <MudText><pre style="text-align:left">@fieldMessage.Definition</pre></MudText>
                                        </TooltipContent>
                                    </MudTooltip>
                                </BodyContent>
                            </MudTreeViewItem>
                        }
                        else
                        {
                            <MudTreeViewItem T="ProtoType">
                                <BodyContent>
                                    <MudText><b>@field.Name:&nbsp;</b></MudText>
                                    @switch (field.Value)
                                    {
                                        case TypedFloat x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedInt32 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedInt64 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedUint32 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedUint64 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedSint32 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedSint64 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedFixed32 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedFixed64 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedSfixed32 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedSfixed64 x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedBool x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedString x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedBytes x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedUnknown x:
                                            <MudText>@x.Value</MudText>
                                            break;
                                        case TypedEnum x:
                                            <MudText>@x.EnumValue</MudText>
                                            break;
                                    }
                                </BodyContent>
                            </MudTreeViewItem>
                        }
                        break;
                }
            </ItemTemplate>
        </MudTreeView>
    </MudItem>
</MudGrid>

@code
{
    private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
    private IBrowserFile? ProtoFile;
    private IBrowserFile? ProtoBinFile;
    HashSet<MessageViewModel> Messages { get; } = new();
    MessageViewModel? SelectedMessage { get; set; }
    ProtoContext? ParseResult { get; set; }

    HashSet<ProtoType>? TypedMessages { get; set; }

    private async Task MessageFileChanged(IBrowserFile file)
    {
        ProtoFile = file;
        Messages.Clear();
        using var ms = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(ms);
        ms.Position = 0;
        ParseResult = ProtoParser.ParseFile(ms);
        var visitor = new MessageViewModel.Visitor();
        visitor.Visit(ParseResult);
        foreach (var m in visitor.Messages.Where(x => x.Parent == null))
        {
            Messages.Add(m);
        }
    }

    private async Task BinFilesChanged(IBrowserFile file)
    {
        ProtoBinFile = file;
        using var ms = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(ms);
        ms.Position = 0;
        using var coded = CodedInputStream.CreateWithLimits(ms, int.MaxValue, int.MaxValue);
        var decoder = new TypedMessageDecoder();
        var result = decoder.Parse(coded, ParseResult, SelectedMessage.MessageDefContext);
        TypedMessages = new(result);
    }
}